namespace = bassenheim_invasion

### Spawn invader with the associated story...
bassenheim_invasion.0001 = {
	scope = none
	hidden = yes
	
	trigger = {
		exists = title:k_bassenheim # update compatibility - new titles in old saves return false
		any_county_in_region = {
			region = special_bassenheim_conquest_region_start
			count > 0
			holder = { is_ai = yes }
		}
		title:k_bassenheim = { is_title_created = no }
	}

	on_trigger_fail = {
		debug_log = "bassenheim story has failed to trigger; trying again next year"
		debug_log_date = yes
	}

	immediate = {
		debug_log = "bassenheim story owner has appeared"
		debug_log_date = yes
				
		spawn_bassenheim_invader_effect = {
			INVADER_DYNN = bassenheim
		}
		scope:invader = {
			create_story = story_bassenheim_invasion
		}
	}
}

# Event for handling new army spawning on succession
bassenheim_invasion.0100 = {
	hidden = yes
	immediate = {
		spawn_bassenheim_troops_effect = yes
	}
}

# Event for declaring the very first war; values like current_ / max_military_strength aren't immediately filled with a value and return 0 instead
bassenheim_invasion.0200 = {
	hidden = yes
	orphan = yes
	trigger = { is_ai = yes } # don't force a player into a war
	immediate = {}
}

##################
# Notification Events
# 1000-1999
##################

### The invader has appeared! Would you like to play as them?
bassenheim_invasion.1001 = { # only players see this
	type = character_event
	title = bassenheim_invasion.1001.t
	desc = bassenheim_invasion.1001.desc
	
	theme = hi_theme_forest_pine

	left_portrait = {
		character = scope:invader
		animation = personality_bold
	}

	trigger = { hi_show_invader_notification_event_trigger = yes }
	
	option = { name = bassenheim_invasion.1001.a }

	option = { # play as the newly spawned invader
		name = bassenheim_invasion.1001.b
		trigger = { hi_play_as_invader_event_option_trigger = yes }
		add_internal_flag = dangerous
		scope:invader = {
			set_variable = {
				name = historicinvasions_previous_ruler_var
				value = root
				months = 1
			}
		}
		set_player_character = scope:invader
	}
}

# pope calls for northern crusade
bassenheim_invasion.1101 = { # only players see this
	type = character_event
	title = bassenheim_invasion.1101.t
	desc = bassenheim_invasion.1101.desc
	
	theme = faith

	left_portrait = {
		character = scope:pope
		animation = happiness
	}

	immediate = {
		play_music_cue = mx_cue_general_crusade_event_2

		faith:catholic.religious_head = { save_scope_as = pope }
	}
	
	option = { name = bassenheim_invasion.1101.a }
}