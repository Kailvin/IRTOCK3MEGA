namespace = keita_invasion

### Spawn invader with the associated story...
keita_invasion.0001 = {
	scope = none
	hidden = yes
	
	trigger = {
		exists = title:e_keita # update compatibility - new titles in old saves return false
		any_county_in_region = {
			region = special_keita_conquest_region_start
			count > 0
			holder = { is_ai = yes }
		}
	}

	on_trigger_fail = {
		debug_log = "keita story has failed to trigger; trying again next year"
		debug_log_date = yes
	}

	immediate = {
		debug_log = "keita story owner has appeared"
		debug_log_date = yes
		
		character:251110 = { save_scope_as = keita_dynasty_origin }

		scope:keita_dynasty_origin.dynasty = {
			# pick an already existing dynasty member
			ordered_dynasty_member = {
				limit = {
					is_landed = yes
					highest_held_title_tier > tier_barony
					capital_county = { title_province = { geographical_region = special_keita_conquest_region_total } }
					is_independent_ruler = yes
					is_adult = yes
					is_healthy = yes
					is_imprisoned = no
					historicinvasions_player_may_become_invader_trigger = yes
					historicinvasions_common_existing_character_restrictions_trigger = yes
				}
				alternative_limit = {
					is_landed = yes
					highest_held_title_tier > tier_barony
					capital_county = { title_province = { geographical_region = special_keita_conquest_region_total } }
					is_adult = yes
					is_healthy = yes
					is_imprisoned = no
					historicinvasions_player_may_become_invader_trigger = yes
					historicinvasions_common_existing_character_restrictions_trigger = yes
				}
				order_by = realm_size
				save_scope_as = invader
			}
		}
		
		# only spawns a new character if scope:invader is not set
		spawn_keita_invader_effect = {
			INVADER_DYNN = keita
		}

		# start story
		scope:invader = {
			create_story = story_keita_invasion
		}
	}
}

# Event for handling army spawning
keita_invasion.0100 = {
	hidden = yes
	immediate = {
		spawn_keita_troops_effect = yes
	}
}

# Event for declaring the very first war; values like current_ / max_military_strength aren't immediately filled with a value and return 0 instead
keita_invasion.0200 = {
	hidden = yes
	trigger = { is_ai = yes } # don't force a player into a war
	immediate = {
		war_target_evaluation_and_declaration_effect = {
			INVADER_DYNN = keita
			INVADER_CHAR = scope:story.story_owner
			INVADER_REGION = total
			INVADER_TARGET_TITLE_TIER = kingdom
			INVADER_RANGE = neighboring
			INVADER_LIEGE_RESTRICTIONS = ""
		}
	}
}

##################
# Notification Events
# 1000-1999
##################

### The invader has appeared! Would you like to play as them?
keita_invasion.1001 = { # only players see this
	type = character_event
	title = keita_invasion.1001.t
	desc = keita_invasion.1001.desc
	
	theme = hi_theme_desert

	left_portrait = {
		character = scope:invader
		animation = personality_bold
	}

	trigger = { hi_show_invader_notification_event_trigger = yes }
	
	option = { name = keita_invasion.1001.a }

	option = { # play as the newly spawned invader
		name = keita_invasion.1001.b
		trigger = { hi_play_as_invader_event_option_trigger = yes }
		add_internal_flag = dangerous
		scope:invader = {
			set_variable = {
				name = historicinvasions_previous_ruler_var
				value = root
				months = 1
			}
		}
		set_player_character = scope:invader
	}
}

########## misc

### faith changes 3 days after spawn to prevent error.log spam
keita_invasion.3001 = {
	type = character_event
	title = keita_invasion.3001.t
	desc = keita_invasion.3001.desc
	
	theme = hi_theme_mountains

	left_portrait = {
		character = root
		animation = personality_zealous
	}

	trigger = { root.faith = { NOT = { this = root.capital_county.faith } } }

	# no conversion
	option = {
		name = keita_invasion.3001.a
		ai_chance = { base = 0 }
	}

	# conversion
	option = {
		name = keita_invasion.3001.b
		add_internal_flag = special
		set_character_faith_with_conversion = root.capital_county.faith
		ai_chance = { base = 100 }
	}
}